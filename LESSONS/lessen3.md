УРОК 3: АНОМАЛЬНОЕ СКАНИРОВАНИЕ И ОБХОД СИСТЕМ ОБНАРУЖЕНИЯ ВТОРЖЕНИЙ (IDS/IPS EVASION)


1. ТЕОРИЯ: КАК НАС ПАЛЯТ? (АНАЛИЗ IDS)

Системы обнаружения вторжений (например, Snort или Suricata) следят за сетью. Они не просто смотрят на пакеты, они ищут паттерны.


ОСНОВНЫЕ ПРИЗНАКИ, ПО КОТОРЫМ ТЕБЯ ВЫЧИСЛЯТ:
1.  Сигнатурный анализ: IDS знает, что Nmap по умолчанию использует Window Size в 1024 байта и определенные опции в TCP-заголовке. Это как отпечаток пальца.
2.  Поведенческий анализ: Если один хост стучится на 100 разных портов за 1 секунду — это сканирование.
3.  RFC Compliance (Соответствие стандартам): Легитимные программы (браузеры) работают по правилам RFC 793. Хакерские утилиты часто создают «невозможные» пакеты (например, без флагов или с противоречивыми флагами).


ТВОЯ СТРАТЕГИЯ ОБХОДА:
Чтобы пройти мимо охраны, ты не должен выглядеть как хакер со сканером. Ты должен выглядеть как «сетевой сбой», «глюк прошивки» или «фрагментированный мусор».

---


2. СКРЫТЫЕ МЕТОДЫ СКАНИРОВАНИЯ (STEALTH TECHNIQUES)


А) NULL SCAN
Мы отправляем пакет, в котором заголовок TCP абсолютно пуст. Ни одного флага.
–   Теория: Согласно RFC, если порт закрыт, устройство должно ответить RST. Если открыт — устройство промолчит.
–   Почему это круто: Нет флага SYN — нет записи о начале сессии. Многие старые IDS просто пропускают такие пакеты.


Б) XMAS (CHRISTMAS TREE) SCAN
В пакете подняты флаги FIN, PSH и URG. Пакет «горит как ёлка».
–   Логика: Это вызывает замешательство в сетевом стеке. Разные ОС реагируют по-разному, что позволяет провести OS Fingerprinting (определить, что за ОС на той стороне).


В) ФРАГМЕНТАЦИЯ (L3 FRAGMENTING)
Ты разбиваешь TCP-заголовок на части. Например, первые 8 байт в одном IP-пакете, остальные 12 — во втором.
–   Логика: IDS часто «ленится» собирать фрагменты для анализа, считая их ошибкой передачи. А целевой сервер обязан их собрать и обработать.

---


3. ПРАКТИКА: ПИШЕМ "GHOST SCANNER" НА СИ

Мы модифицируем наш код из прошлого урока. Теперь мы будем создавать пакеты, которые нарушают логику TCP.

// Настраиваем флаги для Xmas Scan
// Эти строки вставляются в блок заполнения struct tcphdr

tcp->fin = 1; // Конец связи
tcp->psh = 1; // Протолкнуть данные быстрее
tcp->urg = 1; // Срочно!

// Для NULL Scan — просто обнули все флаги:
// tcp->syn = 0; tcp->ack = 0; ... и так далее.

// Чтобы имитировать реальный трафик, меняем TTL и Window Size
ip->ttl = GetRandomValue(64, 128);
tcp->window = htons(2048 + (rand() % 1024));



ПРИМЕР ФРАГМЕНТАЦИИ (НА УРОВНЕ IP):
Для этого нужно изменить поле фрагментации в IP заголовке.
ip->frag_off = htons(IP_MF); // Указываем, что будут еще фрагменты (More Fragments)


---


4. ГЛОССАРИЙ УРОКА (ТЕРМИНОЛОГИЯ)

–   IDS (Intrusion Detection System): Система-стукач. Смотрит на трафик и кричит админу, если видит атаку.
–   TCP Reset (RST): Грубый ответ сервера: «Пошел нахер, я не хочу с тобой говорить».
–   Idle Scan (IPID Scan): Сканирование через посредника. Твой IP вообще не фигурирует в пакетах к жертве.
–   Payload Puffing: Добавление мусорных данных в пакет, чтобы изменить его размер и сбить сигнатурный сканер.

---


5. ДОМАШНЕЕ ЗАДАНИЕ (ДЗ)


ТЕОРЕТИЧЕСКАЯ ЧАСТЬ:
1.  Почему NULL и Xmas сканирование не работает против Windows-машин? (Подсказка: изучи, как стек TCP/IP от Microsoft интерпретирует RFC 793).
2.  Объясни разницу между IDS и IPS. Что произойдет с твоим пакетом в каждой из систем, если его всё-таки обнаружат?
3.  Что такое "Zombie Host"? Каким критериям должен соответствовать компьютер в сети, чтобы ты мог использовать его для скрытого Idle-сканирования?


ПРАКТИЧЕСКАЯ ЧАСТЬ:
1.  Код: Возьми свой сканер из Урока 2 и добавь в него возможность выбора режима: 1 — SYN-скан, 2 — NULL-скан, 3 — Xmas-скан.
2.  Тест: Запусти свой сканер против локального localhost или виртуалки.
3.  Доказательство: Используй sudo tcpdump -nvvv -i lo (на петлевом интерфейсе) и сделай скриншот. Ты должен показать, что в пакете действительно либо нет флагов (NULL), либо их три штуки сразу (Xmas).
4.  Анализ: Посмотри, что отвечает тебе система на NULL-пакет. Если порт открыт, ты увидишь тишину? Документируй результат.

---


ЗОЛОТОЕ ПРАВИЛО УРОКА 3:
 **"Скрытность — это не отсутствие действий. Скрытность — это действия, которые невозможно отличить от фонового шума."**

К следующему уроку: Жду отчет с кодом мульти-сканера и разбором поведения разных ОС. Это отделит тех, кто просто кодит, от тех, кто понимает логику сетевого боя. Вперёд!
