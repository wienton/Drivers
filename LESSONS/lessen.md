
LESSON 1: KERNEL LAND DOMINATION & LOW-LEVEL EXPLOITATION


1. АРХИТЕКТУРА ПОДСИСТЕМ: USER VS KERNEL
В кибербезопасности грань между «защищенностью» и «уязвимостью» проходит по линии System Call Interface (SCI).


ПОНЯТИЙНЫЙ АППАРАТ:
–   Context Switching (Переключение контекста): Процесс перехода CPU из режима Ring 3 в Ring 0. Это дорогостоящая операция, выполняемая через прерывание int 0x80 (x86) или инструкцию syscall (x64). Твоя задача — сидеть внутри этого процесса.
–   VFS (Virtual File System): Абстракция ядра, позволяющая драйверу выглядеть как файл. Всё в Linux — файл. Умение маскировать данные под стандартные файлы /dev/ или /proc/ — база для сокрытия следов.
–   LKM (Loadable Kernel Module): Объектный файл, динамически линкуемый с vmlinux (бинарным образом ядра). В отличие от статически собранного ядра, LKM позволяет реализовать Hot Patching — изменение логики системы без перезагрузки.

---


2. ГЛУБОКОЕ ПОГРУЖЕНИЕ: АССЕМБЛЕРНЫЕ ПРИМИТИВЫ И CPU
Почему мы юзаем инлайн-ассемблер (Inline ASM) в задачах ИБ? Потому что компилятор C (GCC/Clang) слишком «вежлив». Он следует стандартам, а нам нужно их нарушать.


ТЕХНОЛОГИИ КОНТРОЛЯ CPU:
–   Control Registers (CR0, CR3, CR4): Это «рубильники» процессора.
    *   CR0 [Bit 16 - WP (Write Protect)]: Если он равен 1, ядро не может писать в страницы памяти, помеченные «только для чтения» (например, в таблицу системных вызовов). Мы должны уметь «ослеплять» процессор, временно обнуляя этот бит.
–   IDT (Interrupt Descriptor Table): Таблица векторов прерываний. Каждый раз, когда мышка двигается или пакет приходит на карту, CPU смотрит сюда, чтобы узнать, какой код запустить. Хукинг IDT позволяет перехватить управление на уровне аппаратных прерываний (самый скрытный метод).

---


3. СЕТИ: ГЛУБОКИЙ АНАЛИЗ ТРАФИКА (DPI В ЯДРЕ)
Для кибербезопасника сеть — это последовательность структур sk_buff (Socket Buffer).


АНАТОМИЯ ПАКЕТА В ЯДРЕ:
sk_buff — это не просто массив байтов. Это сложная структура со связанными списками и указателями на заголовки разных уровней (L2, L3, L4).
–   Linear & Non-linear data: Пакет может быть разбит на части в памяти. Если ты читаешь только заголовок, ты можешь пропустить нагрузку (payload).
–   Netfilter Priorities: Твой драйвер должен иметь приоритет NF_IP_PRI_FIRST, чтобы видеть пакет раньше, чем это сделает системный файрвол (iptables/nftables).

---


4. МЕТОДОЛОГИЯ РАЗРАБОТКИ УТИЛИТ ИБ


ШАГ 1: ИНФОРМАЦИОННЫЙ СБОР (RECONNAISSANCE)
Прежде чем писать код, изучи целевое ядро.
–   cat /proc/kallsyms — карта всех функций ядра. Если видишь T — функция экспортирована, если t — скрыта (нужен kprobes для поиска).
–   lsmod — анализ загруженных модулей и поиск конфликтов.


ШАГ 2: КОММУНИКАЦИЯ (THE BRIDGE)
Драйвер без управления бесполезен. Создавай Control Channel:
–   Netlink Sockets: Лучший выбор для ИБ. Работает как стандартный сокет, но связывает твою утилиту в User Space с твоим кодом в Kernel Space. Не оставляет следов в файловой системе (в отличие от /dev/).


ШАГ 3: СОКРЫТИЕ (STEALTH)
Настоящий руткит должен:
1.  Удалить себя из списка modules.
2.  Перехватить вызовы ls и ps, чтобы скрыть свои файлы и процессы.
3.  Очищать dmesg, чтобы админ не увидел твои отладочные сообщения.

---


5. ЛАБОРАТОРНЫЙ ПРАКТИКУМ (HARDCORE)


ЗАДАЧА "INTERCEPTOR":
Напиши код на Си (User Space), который будет обмениваться данными с твоим драйвером через Netlink.
1.  Driver: Должен перехватывать все TCP-пакеты на порт 80 (HTTP) и искать в них строку "LOGIN".
2.  User Space Tool: Должна получать от драйвера эти пакеты и записывать их в файл.


ВОПРОСЫ ДЛЯ ЗАЧЕТА:
1.  Race Condition: Что произойдет, если два процесса одновременно вызовут твой драйвер, и как spin_lock решает эту проблему?
2.  Memory Corruption: Почему нельзя использовать printf в ядре? (Ответ: printf — это User Space библиотека, в ядре только printk).
3.  Kernel Stack: Почему в ядре нельзя создавать огромные массивы (например, char buf[1000000])? (Ответ: стек ядра крайне ограничен — обычно 8KB или 16KB).

---


6. РЕСУРСЫ ДЛЯ ФАНАТОВ
Чтобы реально "шарить", тебе нужно читать:
1.  Linux Kernel Development (Robert Love) — библия ядра.
2.  The Rootkit Arsenal (Bill Blunden) — как делать зло правильно.
3.  Phrack Magazine — легендарный журнал для низкоуровневых хакеров.

---
Совет:
 "Если твоя машина не упала в Kernel Panic хотя бы 10 раз за день — значит, ты не занимаешься системным программированием, ты просто балуешься."

Следующий этап: Разбор фаз загрузки ядра и написание дескрипторов для перехвата прерываний клавиатуры. Готовься
